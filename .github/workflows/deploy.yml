name: Deploy to Azure Storage Static Website (SAS)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload site to $web using azcopy (SAS)
        shell: bash
        run: |
          set -e

          # Download azcopy
          curl -L https://aka.ms/downloadazcopy-v10-linux | tar -xz
          AZCOPY=$(find . -type f -name azcopy | head -n 1)
          chmod +x "$AZCOPY"

          # Destination: container $web + SAS (SAS secret must start with '?')
          DEST="https://${{ secrets.AZURE_STORAGE_ACCOUNT }}.blob.core.windows.net/\$web${{ secrets.AZURE_STORAGE_SAS }}"

          # Upload index.html to root of $web
          "$AZCOPY" copy "index.html" "$DEST" --overwrite=true

          # Upload whole data/ folder into $web/data/
          "$AZCOPY" copy "data" "$DEST/data" --recursive=true --overwrite=true