name: Deploy to Azure Storage Static Website (SAS)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload site to $web using azcopy (SAS)
        shell: bash
        run: |
          set -e

          curl -L https://aka.ms/downloadazcopy-v10-linux | tar -xz
          AZCOPY=$(find . -type f -name azcopy | head -n 1)
          chmod +x "$AZCOPY"

          # URL kontenera $web + SAS (sekret musi zaczynać się od '?')
          CONTAINER_URL="https://${{ secrets.AZURE_STORAGE_ACCOUNT }}.blob.core.windows.net/\$web${{ secrets.AZURE_STORAGE_SAS }}"

          # index.html do root
          "$AZCOPY" copy "index.html" "$CONTAINER_URL" --overwrite=true

          # cały folder data/ (zachowa ścieżkę data/...) do kontenera
          "$AZCOPY" copy "data" "$CONTAINER_URL" --recursive=true --overwrite=true